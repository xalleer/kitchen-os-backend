generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum Unit {
  G
  ML
  PCS
}

enum Goal {
  LOSE_WEIGHT
  GAIN_WEIGHT
  MAINTAIN
  SAVE_BUDGET
  HEALTHY
}

enum MealType {
  BREAKFAST
  LUNCH
  DINNER
  SNACK
}

enum Gender {
  MALE
  FEMALE
  UNSPECIFIED
}

model User {
  id       String  @id @default(uuid())
  email    String  @unique
  password String?
  name     String?

  family   Family? @relation(fields: [familyId], references: [id])
  familyId String?

  memberProfile FamilyMember?

  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  UserPreference UserPreference?

  passwordResetCodeHash String?
  passwordResetExpires  DateTime?
}

model UserPreference {
  id     String @id @default(uuid())
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId String @unique

  weight Float?
  height Float?
  age    Int?
  goal   Goal   @default(MAINTAIN)

  allergies Allergy[]

  eatsBreakfast Boolean @default(true)
  eatsLunch     Boolean @default(true)
  eatsDinner    Boolean @default(true)
  eatsSnack     Boolean @default(false)
  
  // ⭐ НОВЕ: Налаштування часу прийому їжі
  breakfastTime String?  // "09:00"
  lunchTime     String?  // "13:00"
  snackTime     String?  // "17:00"
  dinnerTime    String?  // "20:00"
  
  notificationsEnabled Boolean @default(false)
}

model Family {
  id          String   @id @default(uuid())
  name        String
  budgetLimit Decimal? @default(0)

  users   User[]
  members FamilyMember[]

  inventory    InventoryItem[]
  shoppingList ShoppingListItem[]
  mealPlans    MealPlan[]
  
  // ⭐ НОВЕ: Тижневі плани та бюджети
  weeklyMealPlans WeeklyMealPlan[]
  weeklyBudgets   WeeklyBudget[]
  familyInvites   FamilyInvite[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model FamilyMember {
  id   String @id @default(uuid())
  name String

  family   Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  familyId String

  user   User?   @relation(fields: [userId], references: [id])
  userId String? @unique

  gender Gender @default(UNSPECIFIED)
  weight Float?
  height Float?
  age    Int?
  goal   Goal   @default(MAINTAIN)

  allergies Allergy[]

  eatsBreakfast Boolean @default(true)
  eatsLunch     Boolean @default(true)
  eatsDinner    Boolean @default(true)
  eatsSnack     Boolean @default(false)

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  Product   Product[]
  
  // ⭐ НОВЕ: Система інвайтів
  invite    FamilyInvite?
}

// ⭐ НОВЕ: Коди запрошення для членів сім'ї
model FamilyInvite {
  id              String       @id @default(uuid())
  familyId        String
  family          Family       @relation(fields: [familyId], references: [id], onDelete: Cascade)
  
  familyMemberId  String       @unique
  familyMember    FamilyMember @relation(fields: [familyMemberId], references: [id], onDelete: Cascade)
  
  inviteCode      String       @unique
  expiresAt       DateTime?
  usedAt          DateTime?
  usedByUserId    String?
  
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  @@index([inviteCode])
  @@index([familyMemberId])
}

// ⭐ НОВЕ: Тижневі плани харчування
model WeeklyMealPlan {
  id              String    @id @default(uuid())
  familyId        String
  family          Family    @relation(fields: [familyId], references: [id], onDelete: Cascade)
  
  startDate       DateTime
  endDate         DateTime
  isConfirmed     Boolean   @default(false)
  confirmedAt     DateTime?
  
  estimatedCost   Decimal   @default(0)
  
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt
  
  @@unique([familyId, startDate])
  @@index([familyId, isConfirmed])
}

// ⭐ НОВЕ: Тижневий бюджет
model WeeklyBudget {
  id            String   @id @default(uuid())
  familyId      String
  family        Family   @relation(fields: [familyId], references: [id], onDelete: Cascade)
  
  weekStartDate DateTime
  weekEndDate   DateTime
  
  totalBudget   Decimal
  spent         Decimal  @default(0)
  remaining     Decimal  @default(0)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@unique([familyId, weekStartDate])
  @@index([familyId, weekStartDate])
}

// prisma/schema.prisma

// Оновлена модель Product
model Product {
  id                String             @id @default(uuid())
  name              String             @unique
  category          String?
  baseUnit          Unit
  image             String?
  
  averagePrice      Float              @default(0)    // Середня ціна
  minPrice          Float?                             // Мінімальна ціна
  maxPrice          Float?                             // Максимальна ціна
  lastPrice         Float?                             // Остання ціна
  priceUpdatedAt    DateTime           @default(now()) // Коли оновлювалась ціна
  priceSamplesCount Int                @default(0)     // Кількість записів цін
  
  caloriesPer100    Float?
  standardAmount    Float?             // Стандартна тара (1000мл, 500г)
  
  inventoryItems    InventoryItem[]
  shoppingItems     ShoppingListItem[]
  recipeIngredients RecipeIngredient[]
  userPrices        UserProductPrice[] // ⭐ НОВЕ
  FamilyMember      FamilyMember?      @relation(fields: [familyMemberId], references: [id])
  familyMemberId    String?
  
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt @default(now())
  
  @@index([category])
  @@index([name])
}

model UserProductPrice {
  id         String   @id @default(uuid())
  productId  String
  product    Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  
  familyId   String
  userId     String?  // Опційно: хто додав
  
  price      Float    // Ціна за одиницю
  quantity   Float    // Кількість
  totalCost  Float?   // Загальна вартість (price * quantity)
  
  retailer   String?  
  region     String?  
  
  createdAt  DateTime @default(now())
  
  @@index([productId])
  @@index([familyId])
  @@index([createdAt])
}

model InventoryItem {
  id       String @id @default(uuid())
  family   Family @relation(fields: [familyId], references: [id], onDelete: Cascade)
  familyId String

  product   Product @relation(fields: [productId], references: [id])
  productId String

  quantity   Float
  expiryDate DateTime?
  
  // ⭐ НОВЕ: Вирахування з бюджету
  deductFromBudget Boolean  @default(false)
  purchasePrice    Float?   // ціна покупки для вирахування з бюджету

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Recipe {
  id           String @id @default(uuid())
  name         String
  instructions String

  isSaved Boolean @default(false)

  ingredients RecipeIngredient[]
  mealPlans   MealPlan[]
}

model RecipeIngredient {
  id       String @id @default(uuid())
  recipe   Recipe @relation(fields: [recipeId], references: [id])
  recipeId String

  product   Product @relation(fields: [productId], references: [id])
  productId String

  amount Float
}

model MealPlan {
  id       String @id @default(uuid())
  family   Family @relation(fields: [familyId], references: [id])
  familyId String

  date DateTime

  type MealType

  recipe   Recipe @relation(fields: [recipeId], references: [id])
  recipeId String
  
  // ⭐ НОВЕ: Статус приготування
  isCooked   Boolean   @default(false)
  cookedAt   DateTime?
  isSkipped  Boolean   @default(false)
  skippedAt  DateTime?
}

model ShoppingListItem {
  id       String @id @default(uuid())
  family   Family @relation(fields: [familyId], references: [id])
  familyId String

  product   Product @relation(fields: [productId], references: [id])
  productId String

  quantity       Float
  isBought       Boolean  @default(false)
  estimatedPrice Float?
  actualPrice    Float?
  boughtAt       DateTime?

  manualNote String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Allergy {
  id   String @id @default(uuid())
  name String @unique
  slug String @unique

  members         FamilyMember[]
  userPreferences UserPreference[]
}